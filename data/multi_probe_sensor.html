<!DOCTYPE html><head> <style>#exp_state_toggle{background-color: #ffffff; color: black; border: 2px solid #000000; font-size: 72px;}#blow_state_toggle{background-color: #ffffff; color: black; border: 2px solid #000000; font-size: 72px; display: none;}#download_button{background-color: #3dd3db; color: black; border: 2px solid #000000; font-size: 32px; display: none;}#container{height: 400px;}</style> <script>function page_setup(){console.log("Running page setup..."); let system_state=document.getElementById("exp_state_toggle").value; console.log("Initial state: " + String(system_state)); switch (parseInt(system_state)){case 0: console.log("Running page setup 0..."); document.getElementById("exp_state_toggle").style.backgroundColor="GREEN"; document.getElementById("exp_state_toggle").innerHTML="START EXPERIMENT"; document.getElementById("blow_state_toggle").style.display="none"; document.getElementById("download_button").style.display="initial"; break; case 1: console.log("Running page setup 1..."); document.getElementById("exp_state_toggle").style.backgroundColor="RED"; document.getElementById("exp_state_toggle").innerHTML="STOP EXPERIMENT"; document.getElementById("blow_state_toggle").style.display="initial"; document.getElementById("blow_state_toggle").style.backgroundColor="BLUE"; document.getElementById("blow_state_toggle").innerHTML="START BLOW"; document.getElementById("download_button").style.display="none"; break; case 2: console.log("Running page setup 2..."); document.getElementById("exp_state_toggle").style.backgroundColor="RED"; document.getElementById("exp_state_toggle").innerHTML="STOP EXPERIMENT"; document.getElementById("blow_state_toggle").style.display="initial"; document.getElementById("blow_state_toggle").style.backgroundColor="ORANGE"; document.getElementById("blow_state_toggle").innerHTML="STOP BLOW"; document.getElementById("download_button").style.display="none"; break; case 3: console.log("Running page setup 3..."); document.getElementById("exp_state_toggle").style.backgroundColor="RED"; document.getElementById("exp_state_toggle").innerHTML="STOP EXPERIMENT"; document.getElementById("blow_state_toggle").style.display="initial"; document.getElementById("blow_state_toggle").style.backgroundColor="BLUE"; document.getElementById("blow_state_toggle").innerHTML="START BLOW"; document.getElementById("download_button").style.display="none"; break; default: break;}console.log("Page setup done...");}; </script> <script>function downloadUrl(url){document.getElementById('my_iframe').src=url;}; function downloadData(){let url="/spiffs/file?name=/data.csv"; downloadUrl(url);}; </script> <script src="/highcharts.js"></script></head><body onload="page_setup()"> <center> <H1>Virawarn R&D - Experiment Control UI<br>OPTEEV Research</H1><br><button type="button" id="exp_state_toggle" value=%EXP_BUTTON_VALUE% onclick="onButtonClick(this.id)"></button> <button type="button" id="blow_state_toggle" onclick="onButtonClick(this.id)"></button><br></center> <br><H2 id="system_state">Current State: %EXP_BUTTON_VALUE%</H2> <H4>Current State Legend:</H4> <H5>0 - Experiment Stopped or Not Yet Started</H5> <H5>1 - Experiment Started</H5> <H5>2 - Blow Started</H5> <H5>3 - Blow Stopped</H5> <div id="container"></div><button type="button" id="download_button" onclick="downloadData()">DOWNLOAD EXPERIMENT DATA</button><br><iframe id="my_iframe" style="display:none;"></iframe> <script>var chartP=new Highcharts.chart('container',{title:{text: 'Raw Data Plot'}, xAxis:{title:{text: 'Time'}, type: 'datetime', dateTimeLabelFormats:{second: '%%H:%%M:%%S'}}, yAxis:{title:{text: 'Frequency (Hz)'}}, plotOptions:{line:{animation: false}, series:{marker:{enabled: true}}}, credits:{enabled: false}, series: []}); var host=window.location.host; let socket=new WebSocket("ws://" + host + "/ws"); socket.onopen=function (e){}; socket.onmessage=function (event){if (document.getElementById("exp_state_toggle").value > 0){console.log(event.data); const data_array=event.data.split(","); let x=(new Date()).getTime(); if (chartP.series.length < data_array.length - 1){for (let i=0; i < data_array.length - 1; i++){y=parseFloat(data_array[i]); series_name="Probe " + String(chartP.series.length + 1); console.log("Adding series: " + series_name); chartP.addSeries({data: [ [x, y]], name: series_name}, true);}}for (let i=0; i < data_array.length - 1; i++){y=parseFloat(data_array[i]); if (chartP.series[i].data.length > 300){chartP.series[i].addPoint([x, y], false, true, false);}else{chartP.series[i].addPoint([x, y], false, false, false);}if (chartP.series[i].data.length > 20){chartP.series[i].update({marker:{enabled: false}});}}chartP.redraw();}}; socket.onclose=function (event){}; socket.onerror=function (error){}; </script> <script>function buttonAPI(xhr, button){let url="/?sensor=%SENSOR_NAME%"; xhr.open("POST", url, true); xhr.setRequestHeader("Content-Type", "application/json"); let data={action: String(button)}; xhr.send(JSON.stringify(data));}; var plot_line_count=0; function clearPlotLines(chart, line_count){for (let i=0; i < line_count; i++){chartP.xAxis[0].removePlotLine("plot_line_" + String(i));}}function clearSeries(chart){while (chartP.series.length){chartP.series[0].remove();}}function onButtonClick(button){let xhr=new XMLHttpRequest(); xhr.onreadystatechange=function (){if (xhr.readyState==XMLHttpRequest.DONE && xhr.status===200){let json=JSON.parse(xhr.responseText); console.log("System State: " + String(json.system_state)); document.getElementById("exp_state_toggle").value=json.system_state; document.getElementById("system_state").innerHTML="Current State: " + json.system_state; if (document.getElementById("exp_state_toggle").value==1){let xhr2=new XMLHttpRequest(); let url2="/spiffs/remove?name=/data.csv"; xhr2.open("GET", url2, true); xhr2.send(null); clearPlotLines(chartP, plot_line_count); plot_line_count=0; clearSeries(chartP);}if (json.system_state==0){document.getElementById("exp_state_toggle").style.backgroundColor="GREEN"; document.getElementById("exp_state_toggle").innerHTML="START EXPERIMENT"; document.getElementById("download_button").style.display="initial"; document.getElementById("blow_state_toggle").style.display="none";}else{if (json.system_state==1){document.getElementById("blow_state_toggle").style.backgroundColor="BLUE"; document.getElementById("blow_state_toggle").innerHTML="START BLOW";}else if (json.system_state==2){document.getElementById("blow_state_toggle").style.backgroundColor="ORANGE"; document.getElementById("blow_state_toggle").innerHTML="STOP BLOW"; chartP.xAxis[0].addPlotLine({id: "plot_line_" + String(plot_line_count++), value: (new Date()).getTime(), color: 'BLUE', width: 2, label:{text: "BLOW START"}});}else if (json.system_state==3){document.getElementById("blow_state_toggle").style.backgroundColor="BLUE"; document.getElementById("blow_state_toggle").innerHTML="START BLOW"; chartP.xAxis[0].addPlotLine({id: "plot_line_" + String(plot_line_count++), value: (new Date()).getTime(), color: 'ORANGE', width: 2, label:{text: "BLOW END"}});}document.getElementById("exp_state_toggle").style.backgroundColor="RED"; document.getElementById("exp_state_toggle").innerHTML="STOP EXPERIMENT"; document.getElementById("download_button").style.display="none"; document.getElementById("blow_state_toggle").style.display="initial";}}}; buttonAPI(xhr, button);}; </script></body>